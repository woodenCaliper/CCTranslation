# CCTranslation アプリケーション SPEC

## プロジェクト概要
- **プロジェクト名**: CCTranslation
- **作成日**: 2024年
- **開発方式**: KIRO式

## 1. 基本情報


### 1.1 アプリの目的
Windows常駐型の翻訳ユーティリティ。  
ユーザーが Ctrl + C を短時間で 2 回押すことでクリップボードのテキストを翻訳し、ポップアップで表示する。  
素早い翻訳作業を支援し、作業効率を向上させる。

### 1.2 ターゲットユーザー
- 文書作成・翻訳作業を行うビジネスパーソン
- プログラミング・技術文書を扱う開発者
- 学術論文・資料を扱う研究者・学生
- 日常的に多言語テキストを扱うユーザー

### 1.3 プラットフォーム
Windows デスクトップアプリケーション（常駐型）
- **対応OS**: Windows 10 (最低限) / Windows 11
- **アーキテクチャ**: x64 (64bit)
- **動作環境**: .NET Framework 4.8 以降または .NET 6 以降

## 2. 機能要件

### 2.1 主要機能
- **ホットキー翻訳**: Ctrl + C の連続押下でクリップボード翻訳実行
- **ポップアップ表示**: 翻訳結果を非侵入的なポップアップで表示
- **マウス位置表示**: Ctrl+C実行時にマウスカーソル位置にポップアップウィンドウを表示
- **複数ディスプレイ対応**: 複数モニター環境でも適切なディスプレイにウィンドウを表示
  - Windows API (win32api.EnumDisplayMonitors) を使用した正確なモニター情報取得
  - 各ディスプレイの位置、サイズ、デバイス名を正しく検出
  - マウス座標が属するディスプレイを正確に判定
  - 座標がディスプレイ境界外の場合の最適化（最も近いディスプレイを選択）
        - **ウィンドウ位置管理**: 既存ウィンドウがある場合はマウス位置に移動
        - **エスケープキーでウィンドウを閉じる**: アプリのウィンドウがアクティブの時にエスケープキーを押すとウィンドウを閉じる（アプリは常駐継続）
        - **自動言語判別**: 翻訳元言語の自動検出
        - **Google翻訳API連携**: Google Translate API を使用した高精度翻訳
        - **システム常駐**: バックグラウンドでの常時監視

### 2.2 サブ機能
- **翻訳先言語設定**: ユーザーが翻訳先言語を指定可能（ポップアップ内で設定）
- **設定画面**: ホットキー、翻訳先言語、API設定の管理
- **システムトレイ**: 最小化時のトレイアイコン表示、アプリケーション終了
- **ショートカット設定**: ホットキーのカスタマイズ

### 2.3 データ要件
- **入力データ**: クリップボードのテキスト（UTF-8形式）
- **出力データ**: 翻訳結果テキスト
- **設定データ**: 翻訳先言語、API設定、ホットキー設定
- **言語情報**: Google翻訳APIがサポートする言語リスト

## 3. 技術要件

### 3.1 開発環境
- **開発言語**: Python 3.9+
- **フレームワーク**: 
  - GUI: tkinter (標準ライブラリ) または PyQt/PySide
  - 常駐アプリ: pystray (システムトレイ)
  - ホットキー: pynput (クロスプラットフォーム、日本語キーボード対応)
  - HTTP通信: requests
- **データベース**: 不要（ファイルベースの設定・履歴保存）
- **その他ライブラリ**: 
  - googletrans (無料Google翻訳)
  - pyperclip (クリップボード操作)
  - configparser (設定ファイル管理)
  - pywin32 (Windows API アクセス、複数ディスプレイ検出)
  - google-fonts (Noto Sans JP / Roboto フォント)
  - マウス位置取得機能 (tkinter + pywin32)
  - 複数ディスプレイ管理機能 (win32api.EnumDisplayMonitors) 

### 3.2 システム構成
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ユーザー操作   │    │   CCTranslation │    │  Google翻訳API  │
│                 │    │                 │    │                 │
│ Ctrl+C (連続)   │───▶│ クリップボード監視│   │                 │
│                 │    │ ホットキー検出   │    │                 │
└─────────────────┘    │ ポップアップ表示 │◀───│ 翻訳処理        │
                       │ 設定管理        │     │                 │
                       └─────────────────┘    └─────────────────┘
```

**主要コンポーネント**:
- メインアプリケーション (Python)
- ホットキー監視モジュール (pynput使用)
- クリップボード監視モジュール  
- 翻訳処理モジュール (googletrans使用)
- ポップアップ表示モジュール
- 複数ディスプレイ管理モジュール (win32api使用)
- 設定管理モジュール

## 4. 非機能要件

### 4.1 パフォーマンス要件
- **レスポンス時間**: ホットキー検出から翻訳結果表示まで 3秒以内
- **同時接続数**: 単一ユーザー使用（同時接続不要）
- **データ処理量**: クリップボードテキスト（最大10,000文字程度）
- **メモリ使用量**: 50MB以下
- **CPU使用率**: アイドル時5%以下 

### 4.2 セキュリティ要件
- **API制限**: googletransライブラリの制限内での使用
- **プライバシー**: 翻訳データはGoogle翻訳に送信される（利用規約に従う）
- **権限**: 管理者権限不要でインストール・実行可能

### 4.3 可用性要件
- **稼働時間**: システム起動時に自動開始、24時間常駐可能
- **バックアップ**: 設定ファイルのローカル保存
- **エラー処理**: ネットワークエラー時の適切なエラーメッセージ表示
- **復旧**: アプリケーションクラッシュ時の自動再起動機能
- **多重起動防止**: 
  - アプリケーションの重複起動を完全に防止
  - 既に起動中のインスタンスが存在する場合は新規起動を拒否
  - 重複起動試行時には専用のメッセージウィンドウを表示
  - メッセージ内容：「CCTranslationは既に実行中です。システムトレイを確認してください。」 

## 5. UI/UX要件

### 5.1 画面構成
- **ポップアップウィンドウ**: Ctrl+C翻訳実行時に表示される翻訳結果画面
  - ポップアップウィンドウレイアウト詳細を参照のこと
- **システムトレイ**: CCT_icon.ico表示、右クリックメニュー（設定、終了）
- **設定画面**: ホットキー設定、翻訳先言語設定、その他設定（必要最小限）
- **多重起動警告画面**: 既存インスタンス検出時の専用メッセージウィンドウ
  - タイトル：「CCTranslation」
  - メッセージ：「CCTranslationは既に実行中です。システムトレイを確認してください。または、タスクマネージャーから既存のプロセスを終了してから再起動してください。」
  - ボタン：「OK」（ウィンドウを閉じて終了）
- **Windows通知**: Windowsの右からポップアップする通知機能は使用しない
  - **マウス位置ポップアップ**: 
    - Ctrl+C実行時にマウスカーソル位置にポップアップウィンドウを表示
    - 複数ディスプレイ環境では、マウスがあるディスプレイに表示
      - セカンドディスプレイでCtrl+C実行時も、そのディスプレイ内で適切にポップアップ表示
      - ディスプレイ境界を越えないよう、各ディスプレイの作業領域内で表示
    - 既存ウィンドウがある場合は、マウス位置に移動（新規作成しない）
    - ウィンドウサイズ: 適切なサイズで表示（画面からはみ出さない）
    - エラーハンドリング: ディスプレイ情報取得失敗時のフォールバック機能
  - **エスケープキーでウィンドウを閉じる**:
    - アプリのウィンドウがアクティブ（フォーカスがある）状態の時にエスケープキーを押すとウィンドウを閉じる
    - ウィンドウを閉じてもアプリケーション自体は常駐継続（システムトレイに残る）
    - 再度Ctrl+Cを実行すると新しいウィンドウが表示される

### 5.2 デザイン要件
- **カラーパレット**: Windows 10/11のダークモード・ライトモード対応
- **フォント**: Google翻訳と同様のフォント（Noto Sans JP / Roboto）
- **レイアウト**: 最低限のシンプルデザイン、縦型レイアウト
- **アクセシビリティ**: 高DPI対応、キーボードナビゲーション対応
- **ウィンドウサイズ**: リサイズ可能（初期サイズ：500x700px）
- **分割可能**: 翻訳前後エリアの境界をマウスで上下調整可能
- **テキストエリア**: 文章量に応じて自動調整、最大サイズ制限でスクロール対応

### 5.3 ポップアップウィンドウレイアウト詳細

**デフォルト表示（原文エリア展開状態）**:
```
┌───────────────────────────────────────────┐
│ CCTranslation                          ×  │ ← ウィンドウのタイトルバー
│ ▼ 原文 (en)                               │ ←原文タイトル行&トグル。左寄せ表示。原文(en)をクリックすると原文エリア縮小状態に切り替わる
| ┌───────────────────────────────────────┐ │ ← 原文テキストエリア（ここから）。
│ │ Hello, how are you?                   │ │ ← 原文テキストエリア
│ │ This is a sample text.                │ │
│ │ [表示高さ: 翻訳結果エリアと同じ高さ]     │ │
│ │                                       │ │
│ └───────────────────────────────────────┘ │ ← 原文テキストエリア（ここまで）
│ 翻訳結果 (ja)                              │ ← 翻訳結果タイトル行
│ ┌───────────────────────────────────────┐ │ ← 翻訳後テキストエリア（ここから）
│ │ こんにちは、お元気ですか？              │ │   （翻訳結果表示）
│ │ これはサンプルテキストです。             │ │
│ │ [表示高さ: 原文エリアと同じ高さ]         │ │
│ │                                       │ │
│ └───────────────────────────────────────┘ │ ← 翻訳後テキストエリア（ここまで）
├───────────────────────────────────────────┤
│              [結果をコピー]                │ ← ボタンエリア(1行)
└───────────────────────────────────────────┘
```

**CSSフレーム構造（翻訳結果表示 - 展開状態）**:
```
window (Toplevel, bg="blue")
├── button_frame (tk.Frame, bg="red", pack_propagate=False)
│   └── copy_button (tk.Button, bg="orange", relief=tk.SOLID, borderwidth=2, highlightcolor="green")
├── source_frame (tk.Frame, bg="green", pack_propagate=False)
│   ├── source_header (tk.Frame, bg="#f8f9fa", height=35, pack_propagate=False)
│   │   └── source_label (tk.Label, text="▼ 原文 (en)", cursor="hand2", anchor="w")
│   └── source_text_frame (tk.Frame, bg="#ffffff", relief=tk.SUNKEN, bd=1)
│       └── source_text (scrolledtext.ScrolledText, state=tk.DISABLED, relief=tk.FLAT, borderwidth=0)
└── result_frame (tk.Frame, bg="yellow", pack_propagate=False)
    ├── result_header (tk.Frame, bg="#f8f9fa", height=35, pack_propagate=False)
    │   └── result_label (tk.Label, text="翻訳結果 (ja)", anchor="w")
    └── result_text_frame (tk.Frame, bg="#ffffff", relief=tk.SUNKEN, bd=1)
        └── result_text (scrolledtext.ScrolledText, state=tk.DISABLED, relief=tk.FLAT, borderwidth=0)
```

**CSSフレーム構造（翻訳中表示）**:
```
window (Toplevel, bg="blue")
└── main_frame (tk.Frame, bg="#f8f9fa")
    ├── icon_label (tk.Label, text="🔄", font=title_font, bg="#f8f9fa", fg="#007bff")
    ├── status_label (tk.Label, text="翻訳中...", font=title_font, bg="#f8f9fa", fg="#333333")
    ├── progress_frame (tk.Frame, bg="#f8f9fa")
    │   └── progress_bar (ttk.Progressbar, mode='indeterminate')
    └── cancel_button (tk.Button, text="キャンセル", bg="#dc3545", fg="white", relief=tk.FLAT)
```

**CSSフレーム構造（エラー表示）**:
```
window (Toplevel, bg="blue")
└── main_frame (tk.Frame, bg="#f8f9fa")
    ├── icon_label (tk.Label, text="❌", font=title_font, bg="#f8f9fa", fg="#dc3545")
    ├── title_label (tk.Label, text="翻訳エラー", font=title_font, bg="#f8f9fa", fg="#dc3545")
    ├── error_text (scrolledtext.ScrolledText, state=tk.DISABLED, bg="#ffffff", fg="#dc3545", relief=tk.FLAT, borderwidth=1)
    └── button_frame (tk.Frame, bg="#f8f9fa")
```

**フレーム詳細仕様（翻訳結果表示）**:
- **button_frame**: 
  - 背景色: 赤色 (デバッグ用)
  - pack_propagate=False (高さ制御)
  - 配置: side=tk.BOTTOM (最下部固定)
  - 高さ: 動的計算 (button_height + 6px)
- **source_frame**: 
  - 背景色: 緑色 (デバッグ用)
  - pack_propagate=False (高さ制御)
  - 配置: fill=tk.X, padx=20, pady=(5, 0)
  - 高さ: 展開時=利用可能高さ÷2, 縮小時=35px
- **source_header**: 
  - 背景色: #f8f9fa
  - 固定高さ: 35px
  - pack_propagate=False
- **source_text_frame**: 
  - 背景色: #ffffff
  - relief=tk.SUNKEN, bd=1 (境界線)
  - 縮小時は非表示
- **result_frame**: 
  - 背景色: 黄色 (デバッグ用)
  - pack_propagate=False (高さ制御)
  - 配置: fill=tk.X, padx=20, pady=(0, 0)
  - 高さ: 展開時=利用可能高さ÷2, 縮小時=利用可能高さ-35px
- **result_header**: 
  - 背景色: #f8f9fa
  - 固定高さ: 35px
  - pack_propagate=False
- **result_text_frame**: 
  - 背景色: #ffffff
  - relief=tk.SUNKEN, bd=1 (境界線)
- **利用可能高さの計算**:
  - 計算式: window_height - button_frame_height - 60px (パディング・余白)
  - 最小値: 100px
- **高さ均等化**:
  - 展開時: source_frame = result_frame = 利用可能高さ ÷ 2
  - 縮小時: source_frame = 35px, result_frame = 利用可能高さ - 35px
- **コピーボタン仕様**:
  - 背景色: オレンジ
  - relief=tk.SOLID, borderwidth=2
  - highlightcolor="green", highlightthickness=2
  - padx=2, pady=1 (最小サイズ)
  - 配置: ウィンドウ左右中央 (expand=True)

**フレーム詳細仕様（翻訳中表示）**:
- **main_frame**: 
  - 背景色: #f8f9fa
  - 配置: fill=tk.BOTH, expand=True, padx=20, pady=20
- **icon_label**: 
  - テキスト: "🔄"
  - フォント: title_font
  - 背景色: #f8f9fa
  - 文字色: #007bff (青)
- **status_label**: 
  - テキスト: "翻訳中..."
  - フォント: title_font
  - 背景色: #f8f9fa
  - 文字色: #333333
- **progress_frame**: 
  - 背景色: #f8f9fa
  - 配置: fill=tk.X, pady=(0, 10)
- **progress_bar**: 
  - ウィジェット: ttk.Progressbar
  - モード: indeterminate
  - 長さ: window_width - 80px
- **cancel_button**: 
  - テキスト: "キャンセル"
  - 背景色: #dc3545 (赤)
  - 文字色: white
  - relief: tk.FLAT
  - パディング: padx=20, pady=10

**フレーム詳細仕様（エラー表示）**:
- **main_frame**: 
  - 背景色: #f8f9fa
  - 配置: fill=tk.BOTH, expand=True, padx=20, pady=20
- **icon_label**: 
  - テキスト: "❌"
  - フォント: title_font
  - 背景色: #f8f9fa
  - 文字色: #dc3545 (赤)
- **title_label**: 
  - テキスト: "翻訳エラー"
  - フォント: title_font
  - 背景色: #f8f9fa
  - 文字色: #dc3545 (赤)
- **error_text**: 
  - ウィジェット: scrolledtext.ScrolledText
  - 高さ: 8行
  - wrap: tk.WORD
  - フォント: default_font
  - 背景色: #ffffff
  - 文字色: #dc3545 (赤)
  - 状態: tk.DISABLED
  - 境界線: relief=tk.FLAT, borderwidth=1
- **button_frame**: 
  - 背景色: #f8f9fa
  - 配置: fill=tk.X

**状態管理**:
- **source_expanded**: 
  - ウィジェット: tk.BooleanVar
  - デフォルト値: True (展開状態)
  - 用途: 原文エリアの展開/縮小状態管理

**原文エリア縮小状態**:
```
┌───────────────────────────────────────────┐
│ CCTranslation                          ×  │ ← ウィンドウのタイトルバー
│ ▶ 原文 (en)                              │ ← 縮小状態。原文(en)をクリックすると原文エリア展開状態に切り替わる。
│ 翻訳結果 (ja)                              │ ← 翻訳結果タイトル行
│ ┌───────────────────────────────────────┐ │ ← 翻訳後テキストエリア（ここから）
│ │ こんにちは、お元気ですか？              │ │   （翻訳結果表示）
│ │ これはサンプルテキストです。             │ │
│ │                                       │ │
│ │                                       │ │
│ └───────────────────────────────────────┘ │ ← 翻訳後テキストエリア（ここまで）
├───────────────────────────────────────────┤
│              [結果をコピー]                │ ← ボタンエリア(1行)
└───────────────────────────────────────────┘
```

**UI操作詳細**:
- **原文タイトル行&トグル**: 
  - デフォルト状態では原文エリアは展開されている
  - 「▼ 原文 (en)」ボタンをクリックすると原文エリアが縮小される（「▶ 原文 (en)」に変わる）
  - 「▶ 原文 (en)」ボタンをクリックすると原文エリアが再び展開される
  - 原文エリアの表示高さはウィンドウサイズに合わせて自動調整される
- **原文テキストエリア**:
  - ここに表示される内容はクリップボードから取得する
  - ここに表示される内容は編集できない
- **原文テキストエリア**:
  - **自動調整**: 文章量に応じて高さを自動調整
  - **最小高さ**: 1行
  - **スクロール**: 縦スクロールバーで長文対応
  - **折り返し**: テキストの自動折り返し（改行なしテキスト対応）
  - **フォント**: Google翻訳と同様のフォント（Noto Sans JP / Roboto）
  - **フォントサイズ**: 9pt
  - **縮小状態**: 縮小状態時は非表示となり、その表示エリアも開放する
- **高さ設定**: 展開状態では原文テキストエリアと翻訳結果テキストエリアの高さは同じになる
- **翻訳結果テキストエリア**:
  - **自動調整**: 文章量に応じて高さを自動調整
  - **最小高さ**: 1行
  - **折り返し**: テキストの自動折り返し（改行なしテキスト対応）
  - **フォント**: Google翻訳と同様のフォント（Noto Sans JP / Roboto）
  - **フォントサイズ**: 9pt
- **ボタンエリア表示**: 
  - ボタンの文字は10ptとする
  - ウィンドウサイズがどの状態であれ、ボタンエリア（結果をコピー）は必ず表示される
  - 結果をコピーボタンはウィンドウの左右中央に配置される
  - ボタンの下の行はウィンドウの下面の枠となる

- **ウィンドウサイズ**: 
  - **ウィンドウリサイズ**: 右下角をドラッグしてウィンドウ全体のサイズ変更可能
  - **最小サイズ**: 各エリアやボタン、タイトルなどの最小表示量が維持できる範囲までしか縮小できない
  - **初期サイズ**: アプリの初回起動時のサイズは500x700px
- **キー操作**:
  - **ESCキー**: ウィンドウを閉じる

**レイアウト要件**:
- **分割バー廃止**: 分割バーによる手動調整機能は廃止する
- **高さ均等化**: 展開状態では原文テキストエリアと翻訳結果テキストエリアの高さを同じにする
- **最小サイズ保証**: ウィンドウサイズを小さくしても、原文エリア、翻訳結果エリア、ボタンエリアの各部分がつぶれないよう最小サイズを保証する
- **リサイズ対応**: ウィンドウのリサイズ時に、各エリアが適切に再配置され、コンテンツが隠れないよう調整される

**原文縮小要件**
- **縮小方法**: 
  - ▼ 原文 (en)をクリックすると、原文テキストエリアを非表示にします。原文テキストエリアの高さをゼロにして、その下にある項目の位置を非表示にした分だけ上に移動させる。
  - この時、原文テキストエリアは非表示になり、翻訳結果エリアが利用可能な全スペースを使用する。


**システムトレイ仕様**:
- **アイコン**: icon/CCT_icon.ico
- **ツールチップ**: "CCTranslation - 翻訳ユーティリティ"
- **右クリックメニュー**: 
  - バージョン情報
  - 終了（アプリケーションを終了）

## 8. その他

### 8.1 制約事項
- **API制限**: googletransライブラリの無料版制限（リクエスト頻度制限）
- **ネットワーク依存**: インターネット接続必須
- **プラットフォーム**: Windows 10/11専用
- **権限**: 管理者権限不要（ただし、一部ホットキー機能で制限の可能性）
- **キーボード対応**: 日本語キーボード（半角全角変換キー）対応のためpynput使用必須
- **単一インスタンス**: アプリケーションの多重起動は不可（既存インスタンスが存在する場合は起動を拒否）
- **通知制限**: Windowsの右からポップアップする通知機能は使用しない（システムトレイ通知のみ使用）

### 8.2 前提条件
- **開発環境**: Python 3.9+, Visual Studio Code または PyCharm
- **実行環境**: Windows 10/11 (x64), Python 3.9+ ランタイム
- **ネットワーク**: Google翻訳APIへのアクセス可能なインターネット接続
- **依存ライブラリ**: requirements.txtで管理されるPythonパッケージ
- **リソースファイル**: icon/CCT_icon.ico（システムトレイアイコン）

---

**更新履歴**
- 2024-XX-XX: 初版作成
- 2025-01-04: 複数ディスプレイ対応機能の詳細仕様を追加
  - Windows API (win32api.EnumDisplayMonitors) を使用した正確なモニター情報取得機能
  - セカンドディスプレイでの適切なポップアップ表示機能
  - ディスプレイ境界判定とフォールバック機能
