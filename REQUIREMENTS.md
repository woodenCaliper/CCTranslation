# CCTranslation アプリケーション SPEC

## プロジェクト概要
- **プロジェクト名**: CCTranslation
- **作成日**: 2024年
- **開発方式**: KIRO式

## 1. 基本情報


### 1.1 アプリの目的
Windows常駐型の翻訳ユーティリティ。  
ユーザーが Ctrl + C を短時間で 2 回押すことでクリップボードのテキストを翻訳し、ポップアップで表示する。  
素早い翻訳作業を支援し、作業効率を向上させる。

### 1.2 ターゲットユーザー
- 文書作成・翻訳作業を行うビジネスパーソン
- プログラミング・技術文書を扱う開発者
- 学術論文・資料を扱う研究者・学生
- 日常的に多言語テキストを扱うユーザー

### 1.3 プラットフォーム
Windows デスクトップアプリケーション（常駐型）
- **対応OS**: Windows 10 (最低限) / Windows 11
- **アーキテクチャ**: x64 (64bit)
- **動作環境**: .NET Framework 4.8 以降または .NET 6 以降

## 2. 機能要件

### 2.1 主要機能
- **ホットキー翻訳**: Ctrl + C の連続押下でクリップボード翻訳実行
- **ポップアップ表示**: 翻訳結果を非侵入的なポップアップで表示
- **マウス位置表示**: Ctrl+C実行時にマウスカーソル位置にポップアップウィンドウを表示
- **複数ディスプレイ対応**: 複数モニター環境でも適切なディスプレイにウィンドウを表示
  - Windows API (win32api.EnumDisplayMonitors) を使用した正確なモニター情報取得
  - 各ディスプレイの位置、サイズ、デバイス名を正しく検出
  - マウス座標が属するディスプレイを正確に判定
  - 座標がディスプレイ境界外の場合の最適化（最も近いディスプレイを選択）
        - **ウィンドウ位置管理**: 既存ウィンドウがある場合はマウス位置に移動
        - **エスケープキーでウィンドウを閉じる**: アプリのウィンドウがアクティブの時にエスケープキーを押すとウィンドウを閉じる（アプリは常駐継続）
        - **自動言語判別**: 翻訳元言語の自動検出
        - **Google翻訳API連携**: Google Translate API を使用した高精度翻訳
        - **システム常駐**: バックグラウンドでの常時監視

### 2.2 サブ機能
- **翻訳先言語設定**: ユーザーが翻訳先言語を指定可能（ポップアップ内で設定）
- **設定画面**: ホットキー、翻訳先言語、API設定の管理
- **システムトレイ**: 最小化時のトレイアイコン表示、アプリケーション終了
- **ショートカット設定**: ホットキーのカスタマイズ

### 2.3 データ要件
- **入力データ**: クリップボードのテキスト（UTF-8形式）
- **出力データ**: 翻訳結果テキスト
- **設定データ**: 翻訳先言語、API設定、ホットキー設定
- **言語情報**: Google翻訳APIがサポートする言語リスト

## 3. 技術要件

### 3.1 開発環境
- **開発言語**: Python 3.9+
- **フレームワーク**: 
  - GUI: tkinter (標準ライブラリ) または PyQt/PySide
  - 常駐アプリ: pystray (システムトレイ)
  - ホットキー: pynput (クロスプラットフォーム、日本語キーボード対応)
  - HTTP通信: requests
- **データベース**: 不要（ファイルベースの設定・履歴保存）
- **その他ライブラリ**: 
  - googletrans (無料Google翻訳)
  - pyperclip (クリップボード操作)
  - configparser (設定ファイル管理)
  - pywin32 (Windows API アクセス、複数ディスプレイ検出)
  - google-fonts (Noto Sans JP / Roboto フォント)
  - マウス位置取得機能 (tkinter + pywin32)
  - 複数ディスプレイ管理機能 (win32api.EnumDisplayMonitors) 

### 3.2 システム構成
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ユーザー操作    │    │   CCTranslation  │    │  Google翻訳API  │
│                 │    │                 │    │                 │
│ Ctrl+C (連続)   │───▶│ クリップボード監視 │    │                 │
│                 │    │ ホットキー検出   │    │                 │
└─────────────────┘    │ ポップアップ表示 │◀───│ 翻訳処理        │
                       │ 設定管理        │    │                 │
    │                 │
                       └─────────────────┘    └─────────────────┘
```

**主要コンポーネント**:
- メインアプリケーション (Python)
- ホットキー監視モジュール (pynput使用)
- クリップボード監視モジュール  
- 翻訳処理モジュール (googletrans使用)
- ポップアップ表示モジュール
- 複数ディスプレイ管理モジュール (win32api使用)
- 設定管理モジュール

## 4. 非機能要件

### 4.1 パフォーマンス要件
- **レスポンス時間**: ホットキー検出から翻訳結果表示まで 3秒以内
- **同時接続数**: 単一ユーザー使用（同時接続不要）
- **データ処理量**: クリップボードテキスト（最大10,000文字程度）
- **メモリ使用量**: 50MB以下
- **CPU使用率**: アイドル時5%以下 

### 4.2 セキュリティ要件
- **API制限**: googletransライブラリの制限内での使用
- **プライバシー**: 翻訳データはGoogle翻訳に送信される（利用規約に従う）
- **権限**: 管理者権限不要でインストール・実行可能

### 4.3 可用性要件
- **稼働時間**: システム起動時に自動開始、24時間常駐可能
- **バックアップ**: 設定ファイルのローカル保存
- **エラー処理**: ネットワークエラー時の適切なエラーメッセージ表示
- **復旧**: アプリケーションクラッシュ時の自動再起動機能
- **多重起動防止**: 
  - アプリケーションの重複起動を完全に防止
  - 既に起動中のインスタンスが存在する場合は新規起動を拒否
  - 重複起動試行時には専用のメッセージウィンドウを表示
  - メッセージ内容：「CCTranslationは既に実行中です。システムトレイを確認してください。」 

## 5. UI/UX要件

### 5.1 画面構成
- **ポップアップウィンドウ**: Ctrl+C翻訳実行時に表示される翻訳結果画面
  - 翻訳前文章表示エリア（クリップボードから取得）
  - 翻訳後文章表示エリア（翻訳結果）
  - 翻訳結果をクリップボードにコピーボタン
  - 分割バー（翻訳前後エリアのリサイズ可能）
  - エスケープキーでウィンドウを閉じる機能
- **システムトレイ**: CCT_icon.ico表示、右クリックメニュー（設定、終了）
- **設定画面**: ホットキー設定、翻訳先言語設定、その他設定（必要最小限）
- **多重起動警告画面**: 既存インスタンス検出時の専用メッセージウィンドウ
  - タイトル：「CCTranslation」
  - メッセージ：「CCTranslationは既に実行中です。システムトレイを確認してください。または、タスクマネージャーから既存のプロセスを終了してから再起動してください。」
  - ボタン：「OK」（ウィンドウを閉じて終了）
- **Windows通知**: Windowsの右からポップアップする通知機能は使用しない
        - **マウス位置ポップアップ**: 
          - Ctrl+C実行時にマウスカーソル位置にポップアップウィンドウを表示
          - 複数ディスプレイ環境では、マウスがあるディスプレイに表示
            - セカンドディスプレイでCtrl+C実行時も、そのディスプレイ内で適切にポップアップ表示
            - ディスプレイ境界を越えないよう、各ディスプレイの作業領域内で表示
          - 既存ウィンドウがある場合は、マウス位置に移動（新規作成しない）
          - ウィンドウサイズ: 適切なサイズで表示（画面からはみ出さない）
          - エラーハンドリング: ディスプレイ情報取得失敗時のフォールバック機能
        - **エスケープキーでウィンドウを閉じる**:
          - アプリのウィンドウがアクティブ（フォーカスがある）状態の時にエスケープキーを押すとウィンドウを閉じる
          - ウィンドウを閉じてもアプリケーション自体は常駐継続（システムトレイに残る）
          - 再度Ctrl+Cを実行すると新しいウィンドウが表示される

### 5.2 デザイン要件
- **カラーパレット**: Windows 10/11のダークモード・ライトモード対応
- **フォント**: Google翻訳と同様のフォント（Noto Sans JP / Roboto）
- **レイアウト**: 最低限のシンプルデザイン、縦型レイアウト
- **アクセシビリティ**: 高DPI対応、キーボードナビゲーション対応
- **ウィンドウサイズ**: リサイズ可能（最小サイズ：400x600px、初期サイズ：500x700px）
- **分割可能**: 翻訳前後エリアの境界をマウスで上下調整可能
- **テキストエリア**: 文章量に応じて自動調整、最大サイズ制限でスクロール対応

### 5.3 ポップアップウィンドウレイアウト詳細

**デフォルト表示（原文エリア展開状態）**:
```
┌───────────────────────────────────────────┐
│ CCTranslation                          ×  │ ← ウィンドウのタイトルバー
│ ▼ 原文 (en)                               │ 
| ┌───────────────────────────────────────┐ │ ← 展開状態。左寄せ表示。原文(en)をクリックすると原文エリア縮小状態に切り替わる
│ │ Hello, how are you?                   │ │   ← 原文テキストエリア（クリップボードから取得）
│ │ This is a sample text.                │ │
│ │ [最小表示量: 1行]                      │ │
│ │ [表示高さ: ウィンドウに合わせて自動調整] │ │
│ └───────────────────────────────────────┘ │
├═══━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━═──────═┤ ← 分割バー（ドラッグ可能）
│ 翻訳結果 (ja)                              │ 
│ ┌───────────────────────────────────────┐ │ ← 翻訳後テキストエリア
│ │ こんにちは、お元気ですか？              │ │   （翻訳結果表示）
│ │ これはサンプルテキストです。             │ │
│ │ [最小表示量: 1行]                      │ │
│ │ [表示高さ: ウィンドウに合わせて自動調整] │ │
│ └───────────────────────────────────────┘ │
├───────────────────────────────────────────┤
│         [結果をコピー] [閉じる]             │ ← ボタンエリア
└───────────────────────────────────────────┘
```

**原文エリア縮小状態**:
```
┌───────────────────────────────────────────┐
│ CCTranslation                          ×  │ ← ウィンドウのタイトルバー
│ ▶ 原文 (en)                              │ ← 縮小状態。原文(en)をクリックすると原文エリア展開状態に切り替わる。縮小するとテキストボックス部分を非表示にする
├═══━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━═──────═┤ ← 分割バー（ドラッグ可能）。原文テキストエリアが無くなった分上に移動させる
│ 翻訳結果 (ja)                              │
│ ┌───────────────────────────────────────┐ │ ← 翻訳後テキストエリア（全スペース使用）
│ │ こんにちは、お元気ですか？              │ │   （翻訳結果表示）
│ │ これはサンプルテキストです。             │ │
│ │ [表示高さ: ウィンドウに合わせて自動調整] │ │
│ │ [最小表示量: 1行]                      │ │
│ └───────────────────────────────────────┘ │
├───────────────────────────────────────────┤
│         [結果をコピー] [閉じる]             │ ← ボタンエリア
└───────────────────────────────────────────┘
```

**UI操作詳細**:
- **原文表示トグル**: 
  - デフォルト状態では原文エリアは展開されている
  - 「▼ 原文 (en)」ボタンをクリックすると原文エリアが縮小される（「▶ 原文 (en)」に変わる）
  - 「▶ 原文 (en)」ボタンをクリックすると原文エリアが再び展開される
  - 原文エリアの表示高さはウィンドウサイズに合わせて自動調整される
- **分割バー**: 翻訳前後エリアの境界を上下ドラッグして高さ調整
- **ウィンドウリサイズ**: 右下角をドラッグしてウィンドウ全体のサイズ変更
- **最小サイズ**: 400x600px（これ以下は縮小不可）
- **初期サイズ**: 500x700px
- **エスケープキー**: ウィンドウを閉じる

**レイアウト要件**:
- **ボタンエリア表示**: ウィンドウサイズがどの状態であれ、ボタンエリア（結果をコピー、閉じる）は必ず表示される
- **最小サイズ保証**: ウィンドウサイズを小さくしても、原文エリア、翻訳結果エリア、ボタンエリアの各部分がつぶれないよう最小サイズを保証する
- **リサイズ対応**: ウィンドウのリサイズ時に、各エリアが適切に再配置され、コンテンツが隠れないよう調整される

**テキストエリア仕様**:
- **自動調整**: 文章量に応じて高さを自動調整
- **最小高さ**: 80px（短い文章でも読みやすい高さを確保）
- **最大高さ**: 300px（長い文章の場合はスクロール表示）
- **スクロール**: 縦スクロールバーで長文対応
- **折り返し**: テキストの自動折り返し（改行なしテキスト対応）
- **フォント**: Google翻訳と同様のフォント（Noto Sans JP / Roboto）

**システムトレイ仕様**:
- **アイコン**: icon/CCT_icon.ico
- **ツールチップ**: "CCTranslation - 翻訳ユーティリティ"
- **右クリックメニュー**: 
  - 設定画面を開く
  - 終了（アプリケーションを終了）

## 6. 開発計画

### 6.1 マイルストーン
- **Phase 1**: 
- **Phase 2**: 
- **Phase 3**: 

### 6.2 リリース計画
- **Alpha版**: 
- **Beta版**: 
- **正式版**: 

## 7. 運用要件

### 7.1 デプロイ環境
<!-- 本番環境の構成 -->

### 7.2 監視・ログ
<!-- 運用監視の要件 -->

## 8. その他

### 8.1 制約事項
- **API制限**: googletransライブラリの無料版制限（リクエスト頻度制限）
- **ネットワーク依存**: インターネット接続必須
- **プラットフォーム**: Windows 10/11専用
- **権限**: 管理者権限不要（ただし、一部ホットキー機能で制限の可能性）
- **キーボード対応**: 日本語キーボード（半角全角変換キー）対応のためpynput使用必須
- **単一インスタンス**: アプリケーションの多重起動は不可（既存インスタンスが存在する場合は起動を拒否）
- **通知制限**: Windowsの右からポップアップする通知機能は使用しない（システムトレイ通知のみ使用）

### 8.2 前提条件
- **開発環境**: Python 3.9+, Visual Studio Code または PyCharm
- **実行環境**: Windows 10/11 (x64), Python 3.9+ ランタイム
- **ネットワーク**: Google翻訳APIへのアクセス可能なインターネット接続
- **依存ライブラリ**: requirements.txtで管理されるPythonパッケージ
- **リソースファイル**: icon/CCT_icon.ico（システムトレイアイコン）

---

**更新履歴**
- 2024-XX-XX: 初版作成
- 2025-01-04: 複数ディスプレイ対応機能の詳細仕様を追加
  - Windows API (win32api.EnumDisplayMonitors) を使用した正確なモニター情報取得機能
  - セカンドディスプレイでの適切なポップアップ表示機能
  - ディスプレイ境界判定とフォールバック機能
